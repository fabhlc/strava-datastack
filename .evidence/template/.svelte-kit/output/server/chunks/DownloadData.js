import{d as _,n as Q}from"./utils.js";import{c,o as U,v as m,s as R,g as q,h as u,d as G}from"./ssr.js";import{Q as p,r as V}from"./stores.js";import{Query as F,sql as A}from"@uwdata/mosaic-sql";import{query as L}from"@evidence-dev/universal-sql/client-duckdb";import{w as j,d as z}from"./index2.js";import{tidy as C,mutate as T,summarize as g,n as b,nDistinct as x,min as K,max as N,median as W,mean as H,sum as Y}from"@tidyjs/tidy";import X from"ssf";import{P as E,Q as Z,R as J,T as P,U as $,W as ee,X as te,Y as re,Z as ne}from"./VennDiagram.svelte_svelte_type_style_lang.js";import{ExportToCsv as oe}from"export-to-csv";const _e=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global,ae=c((e,t,r,n)=>'<div class="animate-pulse h-full w-full my-2" data-svelte-h="svelte-nbneoa"><span class="sr-only">Loading...</span> <div class="h-full w-full rounded-md bg-base-300"></div></div>');function se(e){return!e||!e[0]||!e.length}const Qe=c((e,t,r,n)=>{let o=_(n),{data:a}=t,i=()=>{},s;return U(i),t.data===void 0&&r.data&&a!==void 0&&r.data(a),p.isQuery(a)&&(a.fetch(),i(),i=a.subscribe(l=>{s=l})),`${a?`${p.isQuery(a)?`${!s||!s.dataLoaded&&!s.error?`${n.skeleton?n.skeleton({loaded:s}):` <div class="w-full h-64">${m(ae,"Skeleton").$$render(e,{},{},{})}</div> `}`:`${s.error&&o.error?`${n.error?n.error({loaded:s}):""}`:`${!s.length&&!s.error&&o.empty?`${n.empty?n.empty({loaded:s}):""}`:`${n.default?n.default({loaded:s}):""}`}`}`}`:` ${(Array.isArray(a)||!a)&&se(a)&&o.empty?` ${n.empty?n.empty({loaded:a}):""}`:` ${n.default?n.default({loaded:a}):""}`}`}`:` ${n.default?n.default({loaded:a}):""}`}`}),ie="___usql_query";let I=L;const Ue=e=>{R(ie,e),I=e},Re=(e,t,r)=>{const n=j(h(e,t,r));let o;return{results:z(n,a=>a),update:async a=>{const{hasQuery:i,query:s}=h(a,t);i?V(()=>{s.hash!==o?.hash&&(o=s,n.set({hasQuery:i,query:s}))},s.fetch()):n.set({hasQuery:!1})}}},h=({value:e,label:t,select:r,data:n,where:o,order:a},i,s)=>{if(!n||!(e||r))return{hasQuery:!1};let l=!1;const d=new F().distinct();if(e&&d.select({value:A`${e}`}),t?d.select({label:A`${t}`}):d.select({label:A`${e}`}),r&&d.select(r),typeof n=="string")n.trim().match(/^[\w]+$/)?d.from(n.trim()):d.from(A(n.trim()));else if(p.isQuery(n))d.from(A`(${n.text})`),l=n.opts.noResolve??!1;else return{hasQuery:!1};o&&d.where(o),a&&(d.orderby(A`${a}`),d.select({ordinal:A`row_number() over (ORDER BY ${a})`}));const f=le(d.toString(),i,s,{noResolve:l});return f.fetch(),{hasQuery:!0,query:f}},le=(e,t,r,n)=>p.create(e,I,t,{...n,initialData:r}),de="customFormattingSettings";function v(e){if(e&&typeof e=="string"){let t=e.split(" ");e.includes(":")||(e=e+"T00:00:00"),t.length>2&&(e=t[0]+" "+t[1]);const r=/\.([^\s]+)/;e=e.replace(r,""),e=e.replace("Z",""),e=e.replace(" ","T")}return e}function qe(e,t){return e=C(e,T({[t]:r=>r[t]?new Date(v(r[t])):null})),e}function Ge(e,t){return e=C(e,T({[t]:r=>v(r[t])})),e}const D="axis",y="value",O=()=>{try{return q(de)?.getCustomFormats()||[]}catch{return[]}},ue=(e,t,r)=>{let n=me(e);if(t.evidenceType==="string")return;if(n){let a=O(),i=[...E,...a].find(s=>s.formatTag?.toLowerCase()===n?.toLowerCase?.());if(i)return i}let o=Z(e,t,r);if(o)return o};function Ae(e,t=void 0){let r=e,n=O(),o=[...E,...n].find(i=>i.formatTag?.toLowerCase()===r?.toLowerCase?.()),a={};return o||(a={formatTag:"custom",formatCode:r},t&&(a.valueType=t),a)}const ce=(e,t=void 0,r=void 0)=>{try{return S(e,t,r,y)}catch(n){return console.warn(`Unexpected error calling applyFormatting(${e}, ${t}, ${y}, ${r}). Error=${n}`),e}},Ve=(e,t=void 0,r=void 0)=>{try{return S(e,t,r,D)}catch{}return e},fe=(e,t)=>{let r=e;if(e&&t?.formatTag){let n=e.toLowerCase().lastIndexOf(`_${t.formatTag.toLowerCase()}`),o="";n>0&&(typeof t?.titleTagReplacement=="string"&&(o=t.titleTagReplacement),r=e.substring(0,n)+o)}return r};function S(e,t=void 0,r=void 0,n=y){if(e==null)return"-";let o;if(t)try{let a=pe(t,n),i;try{t.valueType==="date"&&typeof e=="string"?i=new Date(v(e)):e instanceof Date?i=new Date(e.toISOString().slice(0,-1)):t.valueType==="number"&&typeof e!="number"&&!Number.isNaN(e)?i=Number(e):i=e}catch{i=e}if(J(t,a))try{o=P(i,t,r)}catch(s){console.warn(`Unexpected error applying auto formatting. Error=${s}`)}else o=X.format(a,i)}catch(a){console.warn(`Unexpected error applying formatting ${a}`)}return o===void 0&&(o=$(e)),o}function pe(e,t=y){return typeof e=="string"?e:t===D&&e?.axisFormatCode?e.axisFormatCode:e?.formatCode}function me(e){let t=e.toLowerCase(),r=t.lastIndexOf("_");if(r>0)return t.substr(r).replace("_","")}function Fe(e,t){let r=Ae(t),n=ee(e);return r.valueType=n,ce(e,r)}function ye(e,t){let r=fe(e,t),n=["id","gdp"],o=["of","the","and","in","on"];function a(i){return i.replace(/\S*/g,function(s){return!n.includes(s)&&!o.includes(s)?s.charAt(0).toUpperCase()+s.substr(1).toLowerCase():n.includes(s)?s.toUpperCase():s.toLowerCase()})}return r=a(e.replace(/"/g,"").replace(/_/g," ")),r}const Ce=c((e,t,r,n)=>{let{error:o}=t,{title:a}=t,{minHeight:i="150"}=t;return t.error===void 0&&r.error&&o!==void 0&&r.error(o),t.title===void 0&&r.title&&a!==void 0&&r.title(a),t.minHeight===void 0&&r.minHeight&&i!==void 0&&r.minHeight(i),`<div width="100%" class="${"grid grid-rows-auto grid-cols-1 justify-center relative bg-negative/10 text-negative font-ui font-normal rounded border border-negative/50 min-h-["+u(i,!0)+"px] py-5 px-8 my-5 print:break-inside-avoid"}"><div class="m-auto w-full"><div class="font-bold text-center text-lg">${u(a)}</div> <div class="w-full [word-wrap:break-work] text-xs"><pre class="text-left mx-auto w-fit select-text text-wrap">${u(o)}</pre></div></div></div>`}),ve=c((e,t,r,n)=>{let{error:o=void 0}=t;return t.error===void 0&&r.error&&o!==void 0&&r.error(o),`<span class="group inline-flex items-center relative cursor-help cursor-helpfont-sans px-1 border border-negative/50 py-[1px] bg-negative/10 rounded"><span class="inline font-sans font-medium text-xs text-negative" data-svelte-h="svelte-1e4f3hi">error</span> <span class="hidden font-sans group-hover:inline absolute -top-1 left-[105%] text-sm z-10 px-2 py-1 bg-base-100 border border-base-300 leading-relaxed min-w-[150px] max-w-[400px] rounded-md">${u(o)}</span></span>`}),ge=c((e,t,r,n)=>{let{error:o}=t;return t.error===void 0&&r.error&&o!==void 0&&r.error(o),`<div width="100%" class="inline-block group w-[100px] relative cursor-help cursor-helpfont-sans box-content grid-cols-1 justify-center bg-negative/10 font-ui font-normal rounded border border-negative/50 h-[38px] mt-0.5 py-3 px-3 print:break-inside-avoid"><div class="font-bold text-center text-sm" data-svelte-h="svelte-f1i116">Big Value</div> <div class="m-auto w-[100px]"><div class="text-center [word-wrap:break-work] w-full font-medium text-xs text-negative">error
			<span class="hidden font-sans group-hover:inline-block absolute top-[50%] left-[50%] text-sm z-10 px-2 py-1 bg-base-100 border border-base-300 leading-relaxed min-w-[150px] max-w-[400px] rounded-md z-50 overflow-visible">${u(o)}</span></div></div></div>`}),Le=c((e,t,r,n)=>{let{isInitial:o=!0}=t,{emptySet:a="error"}=t,{emptyMessage:i="No Records"}=t,{chartType:s="Component"}=t,l="Dataset is empty - query ran successfully, but no data was returned from the database";return s==="Big Value"&&(l="Dataset is empty"),a==="error"&&o?console.error("\x1B[31m%s\x1B[0m",`Error in ${s}: ${l}`):a==="warn"&&o&&console.warn(`Warning in ${s}: Dataset is empty - query ran successfully, but no data was returned from the database`),t.isInitial===void 0&&r.isInitial&&o!==void 0&&r.isInitial(o),t.emptySet===void 0&&r.emptySet&&a!==void 0&&r.emptySet(a),t.emptyMessage===void 0&&r.emptyMessage&&i!==void 0&&r.emptyMessage(i),t.chartType===void 0&&r.chartType&&s!==void 0&&r.chartType(s),`${["warn","pass"].includes(a)||!o?`${s==="Value"?`<span class="text-xs text-base-content-muted p-2 my-2 w-full border border-base-300 border-dashed rounded">${u(i)}</span>`:`${s==="Big Value"?`<p class="text-xs text-base-content-muted p-2 pt-[32px] my-0 text-center w-full align-middle h-[80px] border border-base-300 border-dashed rounded min-w-[120px]">${u(i)}</p>`:`<p class="text-xs text-base-content-muted p-2 my-2 w-full border border-base-300 border-dashed rounded">${u(i)}</p>`}`}`:`${s==="Value"?`${m(ve,"ValueError").$$render(e,{error:l},{},{})}`:`${s==="Big Value"?`${m(ge,"BigValueError").$$render(e,{error:l},{},{})}`:`${m(Ce,"ErrorChart").$$render(e,{title:s,error:l},{},{})}`}`}`}`});function w(e,t,r=!0){const n=C(e,r?g({count:b(t),countDistinct:x(t),min:K(t),max:N(t),median:W(t),mean:H(t),sum:Y(t)}):g({count:b(t),countDistinct:x(t)}))[0],{maxDecimals:o,unitType:a}=be(e.map(i=>i[t]));return{min:n.min,max:n.max,median:n.median,mean:n.mean,count:n.count,countDistinct:n.countDistinct,sum:n.sum,maxDecimals:o,unitType:a}}function be(e){if(e==null||e.length===0)return{maxDecimals:0,unitType:"unknown"};{let t=0;for(const r of e){const n=r?.toString().split(".")[1]?.length;n>t&&(t=n)}return{maxDecimals:t,unitType:"number"}}}function je(e,t="object"){const r={},n=te(e);for(const o of Object.keys(e[0])){const a=n.find(d=>d.name?.toLowerCase()===o?.toLowerCase())??{name:o,evidenceType:re.NUMBER,typeFidelity:ne.INFERRED},i=a.evidenceType;let s=a.evidenceType==="number"?w(e,o,!0):w(e,o,!1);a.evidenceType!=="number"&&(s.maxDecimals=0,s.unitType=a.evidenceType);const l=ue(o,a,s);r[o]={title:ye(o,l),type:i,evidenceColumnType:a,format:l,columnUnitSummary:s}}return t!=="object"?Object.entries(r).map(([o,a])=>({id:o,...a})):r}function ze(e,t,r){let n=[];if(e===void 0)throw Error("No data provided");if(typeof e!="object")throw Error("'"+e+"' is not a recognized query result. Data should be provided in the format: data = {"+e.replace("data.","")+"}");if(e[0]===void 0||e.length===0)throw Error("Dataset is empty: query ran successfully, but no data was returned from the database");if(e[0]?.error_object?.error!=null)throw Error("SQL Error: "+e[0]?.error_object?.error?.message);if(t!=null){if(!(t instanceof Array))throw Error("reqCols must be passed in as an array");for(var o=0;o<t.length;o++)if(t[o]==null)throw Error("Missing required columns");if(p.isQuery(e))if(!e.columnsLoaded&&e.dataLoaded){const i=Object.keys(e[0]);for(const s of i)n.push(s)}else for(const i of e.columns)n.push(i.column_name);else for(const i of Object.keys(e[0]))n.push(i);let a;for(o=0;o<t.length;o++)if(a=t[o],!n.includes(a))throw Error("'"+a+"' is not a column in the dataset");if(r!=null&&r[0]!=null){for(o=0;o<r.length;o++)if(a=r[o],!n.includes(a))throw Error("'"+a+"' is not a column in the dataset")}}}const xe={code:"button.svelte-1grvppi svg{stroke:var(--base-content);margin-top:auto;margin-bottom:auto;transition:stroke 200ms}button.svelte-1grvppi{display:flex;cursor:pointer;font-family:var(--ui-font-family);font-size:1em;color:var(--base-content);opacity:0.5;justify-items:flex-end;align-items:baseline;background-color:transparent;border:none;padding:0;margin:0 5px;gap:3px;transition:all 200ms;-moz-user-select:none;-webkit-user-select:none;-o-user-select:none;user-select:none}button.svelte-1grvppi:hover{opacity:1;color:var(--primary);transition:all 200ms}button.svelte-1grvppi:hover svg{stroke:var(--primary);transition:all 200ms}@media(max-width: 600px){button.svelte-1grvppi{display:none}}@media print{button.svelte-1grvppi{display:none}}",map:`{"version":3,"file":"DownloadData.svelte","sources":["DownloadData.svelte"],"sourcesContent":["<script context=\\"module\\">\\n\\texport const evidenceInclude = true;\\n<\/script>\\n\\n<script>\\n\\timport { ExportToCsv } from 'export-to-csv';\\n\\timport { fade } from 'svelte/transition';\\n\\n\\texport let data = undefined;\\n\\texport let queryID = undefined;\\n\\texport let text = 'Download';\\n\\texport let display = true;\\n\\t$: display = display === 'true' || display === true;\\n\\n\\tconst date = new Date();\\n\\tconst localISOTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000)\\n\\t\\t.toISOString()\\n\\t\\t.slice(0, 19)\\n\\t\\t.replaceAll(':', '-');\\n\\n\\texport let downloadData = (data) => {\\n\\t\\tconst options = {\\n\\t\\t\\tfieldSeparator: ',',\\n\\t\\t\\tquoteStrings: '\\"',\\n\\t\\t\\tdecimalSeparator: '.',\\n\\t\\t\\tshowLabels: true,\\n\\t\\t\\tshowTitle: false,\\n\\t\\t\\tfilename: (queryID ?? 'evidence_download') + \` \${localISOTime}\`,\\n\\t\\t\\tuseTextFile: false,\\n\\t\\t\\tuseBom: true,\\n\\t\\t\\tuseKeysAsHeaders: true\\n\\t\\t};\\n\\n\\t\\tconst data_copy = JSON.parse(JSON.stringify(Array.from(data)));\\n\\n\\t\\tconst csvExporter = new ExportToCsv(options);\\n\\n\\t\\tcsvExporter.generateCsv(data_copy);\\n\\t};\\n<\/script>\\n\\n{#if display}\\n\\t<div transition:fade|local={{ duration: 200 }}>\\n\\t\\t<button type=\\"button\\" aria-label={text} class={$$props.class} on:click={downloadData(data)}>\\n\\t\\t\\t<span>{text}</span>\\n\\t\\t\\t<slot>\\n\\t\\t\\t\\t<svg\\n\\t\\t\\t\\t\\twidth=\\"12\\"\\n\\t\\t\\t\\t\\theight=\\"12\\"\\n\\t\\t\\t\\t\\tviewBox=\\"0 0 24 24\\"\\n\\t\\t\\t\\t\\tfill=\\"none\\"\\n\\t\\t\\t\\t\\tstroke-width=\\"2\\"\\n\\t\\t\\t\\t\\tstroke-linecap=\\"round\\"\\n\\t\\t\\t\\t\\tstroke-linejoin=\\"round\\"\\n\\t\\t\\t\\t\\t><path d=\\"M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5\\" /></svg\\n\\t\\t\\t\\t>\\n\\t\\t\\t</slot>\\n\\t\\t</button>\\n\\t</div>\\n{/if}\\n\\n<style>\\n\\tbutton :global(svg) {\\n\\t\\tstroke: var(--base-content);\\n\\t\\tmargin-top: auto;\\n\\t\\tmargin-bottom: auto;\\n\\t\\ttransition: stroke 200ms;\\n\\t}\\n\\n\\tbutton {\\n\\t\\tdisplay: flex;\\n\\t\\tcursor: pointer;\\n\\t\\tfont-family: var(--ui-font-family);\\n\\t\\tfont-size: 1em;\\n\\t\\tcolor: var(--base-content);\\n\\t\\topacity: 0.5;\\n\\t\\tjustify-items: flex-end;\\n\\t\\talign-items: baseline;\\n\\t\\tbackground-color: transparent;\\n\\t\\tborder: none;\\n\\t\\tpadding: 0;\\n\\t\\tmargin: 0 5px;\\n\\t\\tgap: 3px;\\n\\t\\ttransition: all 200ms;\\n\\t\\t-moz-user-select: none;\\n\\t\\t-webkit-user-select: none;\\n\\t\\t-o-user-select: none;\\n\\t\\tuser-select: none;\\n\\t}\\n\\n\\tbutton:hover {\\n\\t\\topacity: 1;\\n\\t\\tcolor: var(--primary);\\n\\t\\ttransition: all 200ms;\\n\\t}\\n\\n\\tbutton:hover :global(svg) {\\n\\t\\tstroke: var(--primary);\\n\\t\\ttransition: all 200ms;\\n\\t}\\n\\n\\t@media (max-width: 600px) {\\n\\t\\tbutton {\\n\\t\\t\\tdisplay: none;\\n\\t\\t}\\n\\t}\\n\\n\\t@media print {\\n\\t\\tbutton {\\n\\t\\t\\tdisplay: none;\\n\\t\\t}\\n\\t}</style>\\n"],"names":[],"mappings":"AA8DC,qBAAM,CAAS,GAAK,CACnB,MAAM,CAAE,IAAI,cAAc,CAAC,CAC3B,UAAU,CAAE,IAAI,CAChB,aAAa,CAAE,IAAI,CACnB,UAAU,CAAE,MAAM,CAAC,KACpB,CAEA,qBAAO,CACN,OAAO,CAAE,IAAI,CACb,MAAM,CAAE,OAAO,CACf,WAAW,CAAE,IAAI,gBAAgB,CAAC,CAClC,SAAS,CAAE,GAAG,CACd,KAAK,CAAE,IAAI,cAAc,CAAC,CAC1B,OAAO,CAAE,GAAG,CACZ,aAAa,CAAE,QAAQ,CACvB,WAAW,CAAE,QAAQ,CACrB,gBAAgB,CAAE,WAAW,CAC7B,MAAM,CAAE,IAAI,CACZ,OAAO,CAAE,CAAC,CACV,MAAM,CAAE,CAAC,CAAC,GAAG,CACb,GAAG,CAAE,GAAG,CACR,UAAU,CAAE,GAAG,CAAC,KAAK,CACrB,gBAAgB,CAAE,IAAI,CACtB,mBAAmB,CAAE,IAAI,CACzB,cAAc,CAAE,IAAI,CACpB,WAAW,CAAE,IACd,CAEA,qBAAM,MAAO,CACZ,OAAO,CAAE,CAAC,CACV,KAAK,CAAE,IAAI,SAAS,CAAC,CACrB,UAAU,CAAE,GAAG,CAAC,KACjB,CAEA,qBAAM,MAAM,CAAS,GAAK,CACzB,MAAM,CAAE,IAAI,SAAS,CAAC,CACtB,UAAU,CAAE,GAAG,CAAC,KACjB,CAEA,MAAO,YAAY,KAAK,CAAE,CACzB,qBAAO,CACN,OAAO,CAAE,IACV,CACD,CAEA,OAAO,KAAM,CACZ,qBAAO,CACN,OAAO,CAAE,IACV,CACD"}`},Ke=c((e,t,r,n)=>{let{data:o=void 0}=t,{queryID:a=void 0}=t,{text:i="Download"}=t,{display:s=!0}=t;const l=new Date,d=new Date(l.getTime()-l.getTimezoneOffset()*6e4).toISOString().slice(0,19).replaceAll(":","-");let{downloadData:f=B=>{const k={fieldSeparator:",",quoteStrings:'"',decimalSeparator:".",showLabels:!0,showTitle:!1,filename:(a??"evidence_download")+` ${d}`,useTextFile:!1,useBom:!0,useKeysAsHeaders:!0},M=JSON.parse(JSON.stringify(Array.from(B)));new oe(k).generateCsv(M)}}=t;return t.data===void 0&&r.data&&o!==void 0&&r.data(o),t.queryID===void 0&&r.queryID&&a!==void 0&&r.queryID(a),t.text===void 0&&r.text&&i!==void 0&&r.text(i),t.display===void 0&&r.display&&s!==void 0&&r.display(s),t.downloadData===void 0&&r.downloadData&&f!==void 0&&r.downloadData(f),e.css.add(xe),s=s==="true"||s===!0,`${s?`<div><button type="button"${G("aria-label",i,0)} class="${u(Q(t.class),!0)+" svelte-1grvppi"}"><span>${u(i)}</span> ${n.default?n.default({}):' <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5"></path></svg> '}</button></div>`:""}`});export{ge as B,de as C,Ke as D,Ce as E,Qe as Q,ae as S,ve as V,Ae as a,Re as b,ze as c,Ve as d,ce as e,ye as f,je as g,Le as h,_e as i,Fe as j,Ue as k,qe as l,le as m,Ge as s};
